# 部署指南

## 一、腾讯云轻量 + TencentDB（推荐）

### 1. 资源准备

- **轻量应用服务器**：建议 2 核 4G 起，系统选 Linux（如 Ubuntu 22.04）
- **TencentDB for PostgreSQL**：与轻量同地域，内网互通；创建实例并建库（如 `wymyk`）

### 2. 服务器环境

```bash
# 安装 Python 3.10+
sudo apt update
sudo apt install -y python3.10 python3.10-venv python3-pip

# 克隆或上传代码到 /opt/a2a（示例）
cd /opt/a2a
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

### 3. 环境变量

在项目根目录创建 `.env`：

```env
DATABASE_URL=postgresql+asyncpg://用户名:密码@TencentDB内网IP:5432/wymyk
ENV=production
```

TencentDB 内网 IP 在控制台「实例详情」中查看；安全组需放通轻量服务器访问 5432。

### 4. 前端构建（可选）

若希望同一域名提供网页与 API：

```bash
cd frontend
npm ci
npm run build
cd ..
```

构建产物在 `frontend/dist`，后端启动时会自动挂载（若存在）。

### 5. 进程守护（systemd）

创建 `/etc/systemd/system/a2a.service`：

```ini
[Unit]
Description=A2A Backend
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/opt/a2a
EnvironmentFile=/opt/a2a/.env
ExecStart=/opt/a2a/.venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 8000
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
```

然后：

```bash
sudo systemctl daemon-reload
sudo systemctl enable a2a
sudo systemctl start a2a
sudo systemctl status a2a
```

### 6. 反向代理（可选）

若使用 Nginx 做 HTTPS 与域名：

```nginx
server {
    listen 443 ssl;
    server_name your-domain.com;
    # ssl 配置略

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

---

## 二、Docker 本地/自建部署

### 后端 + PostgreSQL 同机

项目根目录可建 `docker-compose.yml`（示例）：

```yaml
version: "3.9"
services:
  db:
    image: postgres:15
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: wymyk
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  backend:
    build: .
    environment:
      DATABASE_URL: postgresql+asyncpg://postgres:postgres@db:5432/wymyk
      ENV: production
    ports:
      - "8000:8000"
    depends_on:
      db:
        condition: service_healthy

volumes:
  pgdata:
```

需在项目根目录提供 `Dockerfile`（示例）：

```dockerfile
FROM python:3.11-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY app ./app
COPY sql ./sql
ENV PYTHONPATH=/app
EXPOSE 8000
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

前端可单独构建后挂载到后端，或使用 Nginx 镜像托管 `frontend/dist`。

---

## 三、环境变量汇总

| 变量 | 必填 | 说明 |
|------|------|------|
| `DATABASE_URL` | 是 | PostgreSQL 连接串，需带 `asyncpg`（见上文示例） |
| `ENV` | 否 | `development` / `production`，影响日志等 |
| `API_KEY_HEADER` | 否 | 鉴权 Header 名，默认 `X-API-Key` |
| `SECRET_KEY` | 否 | 预留，当前未用于 JWT 等 |

MCP Server 单独运行时：

| 变量 | 说明 |
|------|------|
| `WYMYK_BASE_URL` | 后端地址，默认 `http://localhost:8000` |
| `WYMYK_API_KEY` | 调用需鉴权工具时使用 |

---

## 四、使用 MySQL

若使用腾讯云 MySQL，需：

1. 执行 `sql/001_schema_mysql.sql` 建表
2. 后端当前默认为 PostgreSQL（asyncpg）；若改用 MySQL，需在代码中替换为支持 MySQL 的驱动（如 aiomysql）并修改 `app/db.py` 与 `app/config.py` 中的连接串格式。当前文档以 PostgreSQL 为准。

---

## 五、健康检查

- 后端：`GET /docs` 或 `GET /v1/capabilities` 返回 200 即表示服务正常
- 数据库：后端启动时会执行建表；若连接失败，启动会报错并退出
