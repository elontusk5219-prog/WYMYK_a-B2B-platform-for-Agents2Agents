# 服务器部署步骤（香港轻量 124.156.137.176）

按顺序执行即可在已购买的服务器上跑起 A2A 平台。

---

## 前置条件

- 已购买腾讯云轻量应用服务器（香港），获得公网 IP（如 124.156.137.176）。
- 已下载并保存 PEM 密钥（如 `A2A.pem`），且本地执行 `chmod 600 A2A.pem`。
- 已在腾讯云控制台放通 **22（SSH）** 和 **8000（应用）** 端口；若用 Nginx 反向代理，再放通 80/443。
- 已购买腾讯云 TencentDB for PostgreSQL（建议与轻量同地域），并记下内网地址、端口、库名、用户名、密码。

---

## 一、在本地执行（同步代码到服务器）

在 **项目根目录** 执行（将 `A2A.pem` 路径和 IP 换成你的）：

```bash
export SSH_KEY=/Users/Apple/Downloads/A2A.pem
chmod 600 "$SSH_KEY"

# 同步代码（排除 .env、node_modules、.git）
rsync -avz -e "ssh -i $SSH_KEY -o StrictHostKeyChecking=no" \
  --exclude '.env' --exclude '__pycache__' --exclude 'frontend/node_modules' \
  --exclude 'frontend/dist' --exclude '.git' \
  ./ ubuntu@124.156.137.176:~/A2A/
```

若系统用户是 `root`，把 `ubuntu` 改成 `root`。

---

## 二、SSH 登录服务器

```bash
ssh -i /Users/Apple/Downloads/A2A.pem ubuntu@124.156.137.176
```

---

## 三、在服务器上安装环境并配置

```bash
cd ~/A2A

# 安装 Python3 与 venv（若无）
sudo apt-get update
sudo apt-get install -y python3 python3-pip python3-venv

# 虚拟环境与依赖
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt

# 创建 .env（必填：数据库连接串）
cat > .env << 'EOF'
DATABASE_URL=postgresql+asyncpg://你的用户名:你的密码@TencentDB内网IP:5432/你的库名
ENV=production
EOF
# 用实际信息替换上面的 用户名、密码、内网IP、库名
nano .env
```

---

## 四、启动服务

**前台试跑（确认无报错再关）：**

```bash
cd ~/A2A && source .venv/bin/activate
uvicorn app.main:app --host 0.0.0.0 --port 8000
```

浏览器访问 `http://124.156.137.176:8000`，应能看到 A2A 前端或 API 根。

**后台常驻（二选一）：**

- 简单：`nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > /tmp/a2a.log 2>&1 &`
- 推荐：使用 systemd，见 [05-部署指南](05-部署指南.md) 中的 unit 示例。

---

## 五、可选：前端构建后同机提供

若希望同一台机同时提供网页与 API：

```bash
cd ~/A2A/frontend
npm ci
npm run build
```

后端已配置：若存在 `frontend/dist`，访问根路径会返回前端页面。

---

## 六、开源范围说明

哪些内容适合放入公开 Git 仓库、哪些保留私有，见 [08-开源与仓库说明](08-开源与仓库说明.md)。
